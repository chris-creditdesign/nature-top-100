<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>The top 100 papers</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<script src="js/jquery-1.7.2.min.js" type="text/javascript"></script>
	  <style scoped>
	    body {
	      margin: 0;
	      font: 13px/1.231 arial,helvetica,clean,sans-serif;
	      color: #333;
	    }
	    a {
	      color: #069;
	      text-decoration: none;
	    }
	    a:visited {
	      color: #5c7996;
	    }
	  </style>
	

</head>
<body>
<style scoped>
.status-message {
  border: 1px solid #c00;
  background: #fac7c7;
  padding: 10px;
  display: none;
}

.js-disabled .status-message, .ie6 .status-message, .ie7 .status-message, .ie8 .status-message {
  display: block;
}

.outer-wrapper {
  width: 100%;
  position: relative;
  border: 1px solid #c8c7cf;
  display: none;
}
.outer-wrapper h2 {
  padding: 10px 10px 0 10px;
  margin: 0;
}
.outer-wrapper h3 {
  padding: 0 10px;
  margin: 0;
}
.outer-wrapper p {
  padding: 10px;
  margin: 0;
}
.outer-wrapper .info-box {
  background-color: #ececec;
  margin: 0 10px 15px 10px;
  clear: both;
}
.outer-wrapper .info-box p {
  padding: 0;
}
.outer-wrapper .info-box svg {
  margin: 0 0 10px 0;
}
.outer-wrapper .life-cycle {
  padding: 10px 10px 0;
}
.outer-wrapper .cites, .outer-wrapper .rank, .outer-wrapper .volume {
  font-weight: bold;
}
.outer-wrapper .journal {
  font-style: italic;
}
.outer-wrapper .life-cycle-chart {
  margin: 10px 0 0;
}
.outer-wrapper .dead-link {
  color: #333;
  text-decoration: none;
  font-style: normal;
  pointer-events: none;
}
.outer-wrapper .head-stand {
  float: left;
  width: 70%;
}
@media (max-width: 901px) {
  .outer-wrapper .head-stand {
    width: 80%;
  }
}
@media (min-width: 716px) and (max-width: 769px) {
  .outer-wrapper .head-stand {
    width: 65%;
  }
}
.outer-wrapper .info-box-controls {
  padding: 10px;
  float: right;
  text-align: right;
  width: 20%;
}
.outer-wrapper .info-box-controls svg {
  margin: 0;
}
@media (max-width: 901px) {
  .outer-wrapper .info-box-controls {
    width: 10%;
  }
  .outer-wrapper .info-box-controls svg {
    margin: 10px 0 0 0;
  }
}
@media (min-width: 716px) and (max-width: 769px) {
  .outer-wrapper .info-box-controls {
    width: 30%;
  }
  .outer-wrapper .info-box-controls svg {
    margin: 0;
  }
}
.outer-wrapper button {
  padding: 0.1em 0.3em;
  background-color: #ececec;
  border: 1px solid #999;
  display: inline-block;
  vertical-align: top;
  font-size: 2em;
  color: #666;
  border-radius: 5px;
  cursor: auto;
  pointer-events: none;
}
.outer-wrapper .active {
  background: #ccc;
  cursor: pointer;
  pointer-events: auto;
}
.outer-wrapper .active:hover {
  background: #aaa;
}
.outer-wrapper .active:active {
  background: #999;
}
.outer-wrapper .axis path, .outer-wrapper .axis line, .outer-wrapper .numbersGroup path, .outer-wrapper .numbersGroup line {
  fill: none;
  stroke: #666;
  shape-rendering: crispEdges;
}
.outer-wrapper .axis text, .outer-wrapper .numbersGroup text {
  font-family: sans-serif;
  fill: #666;
  font-size: 13px;
  shape-rendering: crispEdges;
}
.outer-wrapper .barsGroup rect {
  cursor: pointer;
}
.outer-wrapper .discipline-colour {
  margin: 0 0 5px 0;
  overflow: hidden;
}
@media (min-width: 630px) {
  .outer-wrapper .discipline-colour {
    -webkit-column-count: 3;
    -moz-column-count: 3;
    column-count: 3;
  }
}
@media (max-width: 629px) {
  .outer-wrapper .discipline-colour {
    -webkit-column-count: 2;
    -moz-column-count: 2;
    column-count: 2;
  }
}
.outer-wrapper ul {
  overflow: visible;
  padding-left: 10px;
}
.outer-wrapper ul li {
  list-style: none;
  padding: 0 0 0 10px;
  margin: 4px 0px 8px;
}

</style>
<div class="status-message">
	<p>This interactive graphic requires a modern browser (e.g. Chrome, Safari, Firefox or Internet Explorer 9+) with javascript enabled.</p>
	<p>The Thomson Reuters top 100 cited papers can be downloaded here: <a href="http://www.nature.com/polopoly_fs/7.21247!/file/WebofSciencetop100.xlsx" title="Download Web of Science Top 100.xls 26K" class="file-icon xls-icon">Web of Science Top 100.xls</a></p>
</div>

<div class="outer-wrapper" id="tr-graphic">
	<div class="head-stand">
		<h2>The top 100 papers</h2>
		<p>Click through to explore the Web of Science's all-time top-cited papers. (Data provided by Thomson Reuters, extracted on 7 October 2014).</p>
	</div>

	<div class="info-box-controls">
		<button class="widget-button higher">&#60;</button>
		<svg x="0px" y="0px" width="30px" height="40px">
			<path d="M15,3 L25,20 15,37 5,20Z" fill="#444"></path>
		</svg>
		<button class="widget-button lower">&#62;</button>
	</div>

	<div class="info-box" id="tr-info-box">
		
		<div class="life-cycle" id="tr-life-cycle">
			<p>Rank: <span class="rank"></span> Citations: <span class="cites"></span></p>

			<p><span class="title"></span></p>

			<p><span class="authors"></span><p>

			<a href="" class="paper-link" target="_blank"><span class="journal"></span> <span class="volume"></span>, <span class="page"></span> (<span class="pub-year"></span>).</a>
		</div>
		
		<div class="life-cycle-chart" id="tr-life-cycle-chart"></div>
	</div>

	<div class="chart">
	</div>

	<h3>Discipline colour</h3>	
	<div class="discipline-colour" id="tr-discipline-colour">
	</div>
</div>
<!--[if gt IE 8]><!-->
<script type="text/javascript">
function extendObject (myObject) {
	/*	Referenced from: http://addyosmani.com/resources/essentialjsdesignpatterns/book/#observerpatternjavascript */
	
	/*	Storage for topics that can be broadcast or listened to */
	var topics = {};

	/*	A topic identifyer */
	var subUid = -1;

	/*	Publish or broadcast events of interest
		with a specific topic name and arguments
		such as the data to pass along */
	myObject.publish = function ( topic, args ) {
		
		if ( !topics[topic] ) {
			return false;
		}

		var subscribers = topics[topic];
		var len = subscribers ? subscribers.length : 0;

		while (len--) {
			subscribers[len].func( topic, args );
		}	

		return this;
	};

	/*	Subscribe to events of interest with a specific topic name and a 
		callback function, to be executed with the topic/event is observed */
	myObject.subscribe = function ( topic, func, parent ) {
		
		if ( !topics[topic] ) {
			topics[topic] = [];
		}

		var token = ( ++subUid ).toString();
		topics[topic].push({
			token: token,
			func: func,
			parent: parent
		});
		return token;
	};

}

function tenOrOne(num) {
	if (((num % 10) === 0) || num === 1) {
		return true;
	} else {
		return false;
	}
}

function getColour (x, colour, discipline) {
	var colourIndex = discipline.indexOf(x);

	return colour[colourIndex];
}

function buildDataSet (data) {

	var discipline = [];

	for (var i = 0; i < data.length; i++) {

		var my_discipline = data[i].discipline;

		if (discipline.indexOf(my_discipline) === -1 ) {
			discipline.push(my_discipline);
		}
		
	}

	return discipline;
}

/*	Function to sort papers by citation */
function comparePaper(a,b) {
	if (a.cites < b.cites)
		return 1;
	if (a.cites > b.cites)
		return -1;
	return 0;
}

function BuildWidget (target, params, data) {
	this.target = target;
	this.params = params;
	this.data = data;
	this.pubsub = {};
	this.updatedData = [];
	this.disciplines = [];
	this.lifeCycleData = [];
	this.displayIndex = 0;
	this.format = d3.format("0,000");
	this.parseDate = d3.time.format("%Y").parse;
}

BuildWidget.prototype.buildGraphic = function () {
	this.svg = d3.select(this.target  + " > .chart").append("svg")
		.attr("width", this.params.width + this.params.margin.left + this.params.margin.right)
		.attr("height", this.params.height + this.params.margin.top + this.params.margin.mid + this.params.miniHeight + this.params.margin.bottom);

	this.barsGroup = this.svg.append('g')
						.attr("class","barsGroup")
						.attr("transform","translate(" + this.params.margin.left + "," + this.params.margin.top + ")");

	this.numbersGroup = this.svg.append('g')
						.attr("class","numbersGroup")
						.attr("transform","translate(" + this.params.margin.left + "," + (this.params.margin.top + this.params.height) + ")");

	this.miniGroup = this.svg.append('g')
						.attr("class","miniGroup")
						.attr("transform","translate(" + this.params.margin.left + "," + (this.params.margin.top + this.params.height + this.params.margin.mid) + ")");

	this.brushGroup = this.svg.append('g')
						.attr("class","brushGroup")
						.attr("transform","translate(" + this.params.margin.left + "," + (this.params.margin.top + this.params.height + this.params.margin.mid) + ")");
};

BuildWidget.prototype.buildScales = function () {
	this.axisRange = d3.range(this.data.length);

	this.axisRange.shift();

	this.axisRange.push((this.axisRange[this.axisRange.length - 1] + 1));

	this.yScale = d3.scale.linear()
		.range([this.params.height, 0])
		.domain([0, d3.max(this.data, function(d) { 
			return d.cites;
		})]);

	this.xScale = d3.scale.ordinal()
		.rangeBands([0, this.params.width], 0.4, 0)
		.domain(d3.range(this.data.length));

	this.xScaleBrush = d3.scale.ordinal()
		.rangeBands([0, this.params.width], 0.4, 0)
		.domain(d3.range(this.data.length));

	this.xScaleAxis = d3.scale.ordinal()
		.rangeBands([0, this.params.width], 0.4, 0)
		.domain(this.axisRange);
};

BuildWidget.prototype.buildAxes = function () {
	this.yAxis = d3.svg.axis()
		.scale(this.yScale)
		.tickSize(-this.params.width, 0)
		.ticks(4)
		.orient("left");

	this.xAxis = d3.svg.axis()
		.scale(this.xScaleAxis)
		.tickSize(3,0)
		.tickValues([1,10,20,30,40,50,60,70,80,90,100])
		.orient("bottom");

	/*	Prepare the y axis but do not call .call(xAxis) yet */
	this.svg.append("g")
		.attr("class", "y axis")
		.attr("transform", "translate(" + this.params.margin.left + "," + this.params.margin.top + ")")
	  .append("g")
		.attr("class", "axisLabel")
	  .append("text")
		.attr("transform", "translate(" + -(this.params.margin.left * 0.75) + "," + (this.params.height/2) + "), rotate(-90)")
		.style("text-anchor", "middle")
		.text("Total citations");

	/* Prepare the x axis */
	this.svg.append("g")
		.attr("class","x axis")
		.attr("transform", "translate(" + this.params.margin.left + "," + (this.params.margin.top + this.params.height + this.params.margin.mid + this.params.miniHeight) + ")" )
		.call(this.xAxis)
	  .append("g")
		.attr("class", "axisLabel")
	  .append("text")
		.attr("transform", "translate(" + (this.params.width/2) + "," + (this.params.margin.bottom*0.8) + ")")
		.style("text-anchor", "middle") 
		.text("Ranking");
};

BuildWidget.prototype.buildBrush = function () {
	var self = this;

	var display = function () {
		var selected =  self.xScaleBrush.domain()
								.filter(function(d){
									return (brush.extent()[0] <= self.xScaleBrush(d)) && (self.xScaleBrush(d) <= brush.extent()[1]);
								});

		var start = selected[0];
		var end = selected[selected.length - 1] + 1;

		self.updatedData = self.data.slice(start, end);

		self.updateBars();
	};

	var brushend = function () {
		if (brush.extent()[0] === brush.extent()[1]) {
			d3.select(this).call(brush.extent([0, self.params.width]));
			display();
		}
	};

	var brush = d3.svg.brush()
					.x(this.xScaleBrush)
					.extent([0, this.params.width])
					.on("brush", display)
					.on("brushend", brushend);

	this.brushGroup.append("g")
		.attr("class", "brush")
		.call(brush)
		.selectAll("rect")
		.attr("fill","none")
		.attr("height", this.params.miniHeight );

	this.brushHandleGroup = this.brushGroup.selectAll(".resize").append("g") 
		.attr("transform", function(d, i) {
			return  i ? "translate(" + -(self.params.handleWidth) + ",0)" : "translate(0,0)";   
		});

	this.brushHandleGroup.append("rect")
		.attr("x", 0)
		.attr("y", 0)
		.attr("fill", "#aaa")
		.attr("width", this.params.handleWidth)
		.attr("height", this.params.miniHeight);

	this.brushHandleGroup.append("line")
		.attr("x1", (this.params.handleWidth * 0.65))
		.attr("y1", (this.params.miniHeight * 0.35))
		.attr("x2", (this.params.handleWidth * 0.65))
		.attr("y2", (this.params.miniHeight * 0.65))
		.attr("stroke", "#555")
		.attr("stroke-width", 2);

	this.brushHandleGroup.append("line")
		.attr("x1", (this.params.handleWidth * 0.35))
		.attr("y1", (this.params.miniHeight * 0.35))
		.attr("x2", (this.params.handleWidth * 0.35))
		.attr("y2", (this.params.miniHeight * 0.65))
		.attr("stroke", "#555")
		.attr("stroke-width", 2);
};

BuildWidget.prototype.updateBars = function () {
		var self = this;

		this.xScale.domain(d3.range(this.updatedData.length));
		this.yScale.domain([0, d3.max(this.updatedData, function(d) { return d.cites;})]);

		/* Update */
		this.updateMainBars();
		this.updateMainPaths();
		this.updateMiniBars();
		this.updateNumbers();

		/* Enter… */
		this.enterMainBars();
		this.enterMainPaths();
		this.enterMiniPaths();
		this.enterNumbers();

		/* Exit */
		this.exitMainBars();
		this.exitMainPaths();
		this.exitMiniBars();
		this.exitNumbers();

		/* Call the Y axis to adjust it to the new scale */
		this.svg.select(".outer-wrapper .chart .y")
			.transition()
			.duration(10)
			.call(this.yAxis);

		this.upDatePointer();

		this.barsGroup.selectAll("rect").on("click", function (d,i) {
			self.displayIndex = d.rank -1;

			self.pubsub.publish("newIndexChosen", self.displayIndex);
		});
};

BuildWidget.prototype.enterMainBars = function() {
	var self = this;

	this.barsGroup.selectAll("rect")
		.data(this.updatedData, function (d) {
			return d.title;
		})
		.enter()
		.append("rect")
		.attr("x", function (d, i) {
			return self.xScale(i);
		})
		.attr("width", function(d) {
			return self.xScale.rangeBand();
		})
		.attr("y", function (d){
			return self.yScale(d.cites);
		})
		.attr("height", function (d) {
			return self.params.height - self.yScale(d.cites);
		})
		.attr("fill", function (d, i){
			return getColour(d.discipline, self.params.colour, self.disciplines);
		})
		.attr("opacity", function () {
			return 1;
		});
};

BuildWidget.prototype.updateMainBars = function () {
	var self = this;

	this.barsGroup.selectAll("rect").data(this.updatedData, function (d) {
			return d.title;
		})
		.attr("x", function (d, i) {
			return self.xScale(i);
		})
		.attr("width", function (d) {
			return self.xScale.rangeBand();
		})
		.attr("y", function (d){
			return self.yScale(d.cites);
		})
		.attr("height", function (d) {
			return self.params.height - self.yScale(d.cites);
		});
};

BuildWidget.prototype.exitMainBars = function () {
	this.barsGroup.selectAll("rect").data(this.updatedData, function (d) {
			return d.title;
		}).exit()
		.remove();
};

BuildWidget.prototype.enterMiniBars = function () {
	var self = this;

	this.miniGroup.selectAll("rect")
		.data(this.updatedData, function (d) {
			return d.title;
		})
		.enter()
		.append("rect")
		.attr("x", function (d, i) {
			return self.xScale(i);
		})
		.attr("width", function(d) {
			return self.xScale.rangeBand();
		})
		.attr("y", function (d){
			return 0;
		})
		.attr("height", function (d) {
			return self.params.miniHeight;
		})
		.attr("fill", function (d, i){
			return getColour(d.discipline, self.params.colour, self.disciplines);
		})
		.attr("opacity", function () {
			return 1;
		});
};

BuildWidget.prototype.updateMiniBars = function () {
	var self = this;

	this.miniGroup.selectAll("rect").data(this.updatedData, function (d) {
			return d.title;
		})
		.attr("fill", function (d, i){
			return getColour(d.discipline, self.params.colour, self.disciplines);
		});
};

BuildWidget.prototype.exitMiniBars = function () {
	this.miniGroup.selectAll("rect").data(this.updatedData, function (d) {
			return d.title;
		}).exit()
		.attr("fill", "#ececec");
};

BuildWidget.prototype.enterMainPaths = function() {
	var self = this;

	this.barsGroup.selectAll("path")
		.data(this.updatedData, function (d) {
			return d.title;
		})
		.enter().append("path")
		.attr("d", d3.svg.symbol().type("diamond"))
		.attr("class", function(d) {
			return "rank" + d.rank;
		})
		.attr("fill","#444")
		.attr("transform", function(d,i) {
			var verticalTranslate = self.yScale(d.cites) -7;
			var scale = "0.9";
			return "translate(" + (self.xScale(i) + (self.xScale.rangeBand()/2)) + "," + verticalTranslate + "), scale(" + scale + ")"; 
		})
		.attr("opacity", 0);
};

BuildWidget.prototype.updateMainPaths = function () {
	var self = this;

	this.barsGroup.selectAll("path").data(this.updatedData, function (d) {
			return d.title;
		})
		.attr("class", function (d) {
			return "rank" + d.rank;
		})
		.attr("fill","#444")
		.attr("transform", function (d,i) {
			/* Catch an error if trying to translate 0 paths */
			var horizTranslate;
			if (self.xScale(i) === undefined) {
				horizTranslate = 0;
			} else {
				horizTranslate = (self.xScale(i) + (self.xScale.rangeBand()/2));
			}
			return "translate(" + horizTranslate + "," + (self.yScale(d.cites) -7) + "), scale(0.9)"; 
		})
		.attr("opacity", 0);
};

BuildWidget.prototype.exitMainPaths = function () {
	this.barsGroup.selectAll("path").data(this.updatedData, function (d) {
			return d.title;
		}).exit()
		.remove();
};

BuildWidget.prototype.enterMiniPaths = function () {
	var self = this;

	this.miniGroup.selectAll("path")
		.data(this.updatedData, function (d) {
			return d.title;
		})
		.enter().append("path")
		.attr("d", d3.svg.symbol().type("diamond"))
		.attr("class", function(d) {
			return "rank" + d.rank;
		})
		.attr("fill","#444")
		.attr("transform", function(d,i) {
			var verticalTranslate = -7;
			var scale = "0.8";
			return "translate(" + (self.xScale(i) + (self.xScale.rangeBand()/2)) + "," + verticalTranslate + "), scale(" + scale + ")"; 
		})
		.attr("opacity", 0);
};

BuildWidget.prototype.enterNumbers = function () {
	var self = this;

	this.numbersGroup.selectAll("text").data(this.updatedData, function (d) {
			return d.title;
		})
		.enter()
		.append("text")
		.attr("x", function (d, i) {
			return self.xScale(i) + (self.xScale.rangeBand() / 2) ;
		})
		.attr("y", 5)
		.attr("dy", ".8em")
		.style("text-anchor", "middle")
		.text(function (d) {
			return tenOrOne(d.rank) ? d.rank : "";
		});

	this.numbersGroup.selectAll("line").data(this.updatedData, function(d) {
			return d.title;
		})
		.enter()
		.append("line")
		.attr("x1", function (d, i) {
			return self.xScale(i) + (self.xScale.rangeBand() / 2) ;
		})
		.attr("y1", 0)
		.attr("x2", function (d, i) {
			return self.xScale(i) + (self.xScale.rangeBand() / 2) ;
		})
		.attr("y2", function(d) {
			return tenOrOne(d.rank) ? 3 : 0;
		});
};

BuildWidget.prototype.updateNumbers = function () {
	var self = this;

	this.numbersGroup.selectAll("text").data(this.updatedData, function (d){
			return d.title;
		})
		.attr("x", function (d,i){
			return self.xScale(i) + (self.xScale.rangeBand() / 2);
		})
		.text(function (d) {
			return tenOrOne(d.rank) ? d.rank : "";
		});

	this.numbersGroup.selectAll("line").data(this.updatedData,function(d) {
			return d.title;
		})
		.attr("x1", function (d, i) {
			return self.xScale(i) + (self.xScale.rangeBand() / 2) ;
		})
		.attr("y1", 0)
		.attr("x2", function (d, i) {
			return self.xScale(i) + (self.xScale.rangeBand() / 2) ;
		})
		.attr("y2", function (d) {
			return tenOrOne(d.rank) ? 3 : 0;
		});
};

BuildWidget.prototype.exitNumbers = function () {
	this.numbersGroup.selectAll("text").data(this.updatedData, function (d) {
			return d.title;
		}).exit()
		.remove();

	this.numbersGroup.selectAll("line").data(this.updatedData, function (d) {
			return d.title;
		}).exit()
		.remove();
};

BuildWidget.prototype.upDatePointer = function () {

		this.barsGroup.selectAll("path")
			.attr("opacity", 0);

		this.barsGroup.select("path.rank" + (this.displayIndex + 1))
			.attr("opacity", 1);

		this.miniGroup.selectAll("path")
			.attr("opacity", 0);

		this.miniGroup.select("path.rank" + (this.displayIndex+ 1))
			.attr("opacity", 1);
};

BuildWidget.prototype.indexChosen = function ( topic, func, parent ) {
	this.parent.upDatePointer();
	this.parent.updateLifeCycleLine();
	this.parent.populateInfoBox();
	this.parent.upDateButtons();
};

BuildWidget.prototype.buttonClick = function() {
	var self = this;

	jQuery(this.target + ' button.widget-button').click(function () {
		if (jQuery(this).hasClass('lower') && (self.displayIndex < 99)) {
			self.displayIndex++;
		} else if (jQuery(this).hasClass('higher') && (self.displayIndex > 0)) {
			self.displayIndex--;	
		}
		
		self.pubsub.publish("newIndexChosen", self.displayIndex);
	});
};

BuildWidget.prototype.upDateButtons = function () {
	jQuery(this.target + ' button.widget-button').removeClass("active");

	if ( this.displayIndex < 99 ) {
		jQuery(this.target + ' button.widget-button.lower').addClass("active");
	}

	if ( this.displayIndex > 0 ) {
		jQuery(this.target + ' button.widget-button.higher').addClass("active");
	}
};

BuildWidget.prototype.prepareLifeCycelData = function () {
	for (var i = 0; i < this.data.length; i++) {
		for (var y = 0; y < this.data[i].lifeCycle.length; y++) {
			this.data[i].lifeCycle[y].date = this.parseDate(this.data[i].lifeCycle[y].year);
		}
	}
};

BuildWidget.prototype.buildLifeCycle = function () {
	this.lifeCycleSvg = d3.select(this.target + " > .info-box > .life-cycle-chart").append("svg")
		.attr("width", this.params.lifeCycleWidth + this.params.lifeCycleMargin.left + this.params.lifeCycleMargin.right)
		.attr("height", this.params.lifeCycleHeight + this.params.lifeCycleMargin.top + this.params.lifeCycleMargin.bottom)
	  .append("g")
		.attr("transform", "translate(" + this.params.lifeCycleMargin.left + "," + this.params.lifeCycleMargin.top + ")");

	this.lifeCycleSvg.append("g")
		.attr("class","white-box")
	  .append("rect")
		.attr("x", 0)
		.attr("y", 0)
		.attr("width", this.params.lifeCycleWidth)
		.attr("height", this.params.lifeCycleHeight)
		.attr("fill","#FFF");
};

BuildWidget.prototype.buildLifeCycleScales = function () {
	this.xScaleLifeCycle = d3.time.scale()
		.range([0, this.params.lifeCycleWidth])
		.domain([this.parseDate("1925"), this.parseDate("2013")]);

	this.yScaleLifeCycle = d3.scale.linear()
		.range([this.params.lifeCycleHeight, 0])
		.domain([0, (d3.max(this.data[this.displayIndex].lifeCycle, function(d) { return d.cites; }) * 1.1) ]);
};

BuildWidget.prototype.buildLifeCycleAxes = function () {
	var self = this;

	this.xAxisLifeCycle = d3.svg.axis()
		.scale(this.xScaleLifeCycle)
		.ticks(5)
		.orient("bottom");

	this.yAxisLifeCycle = d3.svg.axis()
		.scale(this.yScaleLifeCycle)
		.ticks(5)
		.tickSize(-this.params.lifeCycleWidth, 0)
		.orient("left");

	this.line = d3.svg.line()
		.x(function(d) { return self.xScaleLifeCycle(d.date); })
		.y(function(d) { return self.yScaleLifeCycle(d.cites); });

	this.lifeCycleSvg.append("g")
	    .attr("class", "x axis")
	    .attr("transform", "translate(0," + this.params.lifeCycleHeight + ")")
	    .call(this.xAxisLifeCycle);

	this.lifeCycleSvg.append("g")
	    .attr("class", "y axis")
	    .call(this.yAxisLifeCycle)
	  .append("text")
	    .attr("transform", "translate(" + -(this.params.lifeCycleMargin.left * 0.9) + "," + (this.params.lifeCycleHeight/2) + "), rotate(-90)")
	    .attr("y", 6)
	    .attr("dy", ".5em")
	    .style("text-anchor", "middle")
	    .text("Citations per year");

	this.lifeCycleSvg.append("path")
		.datum(this.data[this.displayIndex].lifeCycle)
		.attr("class","line")
		.attr("fill", "none")
		.attr("stroke", "#cf5568")
		.attr("stroke-width", "3px")
		.attr("d", this.line);
};

BuildWidget.prototype.updateLifeCycleLine = function () {

	if (this.data[this.displayIndex].lifeCycle.length > 0) {
	
		this.yScaleLifeCycle.domain([0, (d3.max(this.data[this.displayIndex].lifeCycle, function(d) { return d.cites; }) * 1.1) ]);

		this.lifeCycleSvg.select(".outer-wrapper .life-cycle-chart .y")
			.transition()
			.duration(150)
			.call(this.yAxisLifeCycle);
			
		this.lifeCycleSvg.selectAll(".outer-wrapper .life-cycle-chart path.line")
			.data([this.data[this.displayIndex].lifeCycle])
			.attr("d", this.line);

	} else {
		this.lifeCycleSvg.selectAll(".outer-wrapper .life-cycle-chart path.line")
			.data([this.data[this.displayIndex].lifeCycle])
			.attr("d", "M0,0 L0,0");	
	}
};

BuildWidget.prototype.populateInfoBox = function () {
	jQuery(".life-cycle .rank").text(this.data[this.displayIndex].rank);
	jQuery(".life-cycle .cites").text(this.format(this.data[this.displayIndex].cites));

	jQuery(".life-cycle .title").html(this.data[this.displayIndex].title);
	jQuery(".life-cycle .authors").html(this.data[this.displayIndex].authors);

	if (this.data[this.displayIndex].hyperlink !== "0") {
		if (jQuery(".life-cycle a.paper-link").hasClass('dead-link')) {
			jQuery(".life-cycle a.paper-link").removeClass('dead-link');
		}
		jQuery(".life-cycle a.paper-link").prop("href", this.data[this.displayIndex].hyperlink);
	} else {
	if (!jQuery(".life-cycle a.paper-link").hasClass('dead-link')) {
			jQuery(".life-cycle a.paper-link").addClass('dead-link');
		}
		jQuery(".life-cycle a.paper-link").prop("href", "#");
	}
	
	jQuery(".life-cycle .journal").text(this.data[this.displayIndex].journal);
	jQuery(".life-cycle .volume").text(this.data[this.displayIndex].volume);
	jQuery(".life-cycle .page").html(this.data[this.displayIndex].page);
	jQuery(".life-cycle .pub-year").text(this.data[this.displayIndex]["pub-year"]);

};

BuildWidget.prototype.createKey = function () {
	var self = this;
	var sortedData = [];

	for (var i = 0; i < this.disciplines.length; i++) {
		sortedData.push(this.disciplines[i]);
	}

	sortedData.sort();

	/* Create checkboxes for each discipline */
	d3.select(this.target + " > .discipline-colour")
		.append("ul")
		.selectAll('li')
	  .data(sortedData)
		.enter()
		.append("li")
		.style("border-left",function (d, i) {
			return "20px solid " + getColour (d, self.params.colour, self.disciplines);
		})
		.html(function(d,i) {			
			return d;
		});
};

(function() {
		var init = function($)
		{

		/*	==================================================================================== */
		/*	jQuery ready */

		$.getScript("http://www.nature.com/widget_assets_polopoly/thRoData.min.js", function() {

				/*	==================================================================================== */
				/*	Load D3 */
				$.getScript("http://www.nature.com/polopoly_static/js/d3.v3.min.js", function() {
					
					/*	Both jQuery and D3 are available so hide the status message and show the graphic */
					$(".status-message").css("display","none");
					$(".outer-wrapper").css("display","block");

					var height = 400;

					/*	Reduce height of main graphic for smaller screens */
					if (jQuery('.section').width() < 480 ) {
						height = 300;
					}

					var thRoParams = {};

					thRoParams.colour =  ["#c1272d",   /* Biology lab technique */
											"#2a6755", /* Physical chemistry */
											"#fbb03b", /* Bioinformatics */
											"#d9e021", /* Statistics */
											"#39b54a", /* Crystallography */
											"#00a99d", /* Psychology */
											"#0071bc", /* Phylogenetics */
											"#1b1464", /* Physics */
											"#93278f", /* Mathematics */
											"#8c6239"  /* Medicine */
										];

					/*	Margin, Width and height */
					thRoParams.margin = {top: 15, right: 30, bottom: 40, left: 80, mid: 40};
					thRoParams.lifeCycleMargin = {top: 10, right: 10, bottom: 20, left: 70};
					thRoParams.width = jQuery('.section').width()  - thRoParams.margin.left - thRoParams.margin.right;
					thRoParams.miniHeight = 60;
					thRoParams.lifeCycleHeight = 100;
					thRoParams.lifeCycleWidth = jQuery('.info-box').width() - thRoParams.lifeCycleMargin.left - thRoParams.lifeCycleMargin.right;
					thRoParams.height = height - thRoParams.margin.top - thRoParams.margin.mid - thRoParams.miniHeight - thRoParams.margin.bottom;
					thRoParams.handleWidth = 15;
					/*	Global variable to control the length of D3 transitons */
					thRoParams.duration = 450;
					thRoParams.delay = 450;
					thRoParams.activeRecord = {};
					thRoParams.topData = [];
					thRoParams.displayArray = [];
					thRoParams.disciplineArray = [];
					
					var thRoGraphic = new BuildWidget("#tr-graphic", thRoParams, thRoData);

					extendObject(thRoGraphic.pubsub);

					/*	Create subscription for a new index being chosen */
					thRoGraphic.pubsub.subscribe( "newIndexChosen", thRoGraphic.indexChosen, thRoGraphic );
					
					thRoGraphic.data.sort(comparePaper);

					for (var i = 0; i < thRoGraphic.data.length; i++) {
						thRoGraphic.data[i].rank = (i + 1);
					}
					thRoGraphic.prepareLifeCycelData();

					thRoGraphic.updatedData = thRoGraphic.data.slice(0);
					thRoGraphic.disciplines = buildDataSet(thRoGraphic.data);
					
					thRoGraphic.buildGraphic();
					thRoGraphic.buildScales();
					thRoGraphic.buildAxes();
					thRoGraphic.buildBrush();
					thRoGraphic.enterMiniBars();
					thRoGraphic.updateBars();

					thRoGraphic.populateInfoBox();

					thRoGraphic.buildLifeCycle();
					thRoGraphic.buildLifeCycleScales();
					thRoGraphic.buildLifeCycleAxes();
					

					thRoGraphic.buttonClick();
					thRoGraphic.upDateButtons();

					thRoGraphic.createKey();

				}); /* End of d3js getscript call */
			
			}); /*	End of the get thRoData.js callback function */

		}; /* End of active code */

	setTimeout(function()
	{
	if (typeof jQuery !== 'undefined')
	{
		init(jQuery);
	} else
	{
		setTimeout(arguments.callee, 60);
	}
	}, 60);

})();
</script>
<!--<![endif]-->
</body>
</html>