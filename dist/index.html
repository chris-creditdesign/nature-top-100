<style scoped>
.status-message {
  border: 1px solid #c00;
  background: #fac7c7;
  padding: 10px;
}

.outer-wrapper {
  width: 100%;
  min-height: 900px;
  position: relative;
  border: 1px solid #c8c7cf;
  /* tool-tip
  ----------------------------------*/
  /* SVG axes
  ----------------------------------*/
}
.outer-wrapper h2, .outer-wrapper h3, .outer-wrapper p {
  padding: 10px 10px 0 10px;
  margin: 0;
}
@media (min-width: 630px) {
  .outer-wrapper .choose-option {
    -webkit-column-count: 2;
    -moz-column-count: 2;
    column-count: 2;
  }
}
.outer-wrapper ul {
  overflow: visible;
  padding-left: 10px;
}
.outer-wrapper ul li {
  list-style: none;
  padding: 0px;
  margin: 4px 0px 8px;
}
.outer-wrapper select {
  margin-left: 10px;
  margin-bottom: 10px;
}
.outer-wrapper label {
  display: inline-block;
  width: 80%;
  cursor: pointer;
}
.outer-wrapper input[type="checkbox"] {
  cursor: pointer;
  display: inline-block;
  height: 20px;
  margin-right: 15px;
  position: relative;
  width: 20px;
  -webkit-appearance: none;
  vertical-align: top;
}
.outer-wrapper input[type="checkbox"]:after {
  content: "\2714";
  font-size: 1.5em;
  display: inline-block;
  left: 0.25em;
  position: relative;
  top: 0.1em;
  color: #666;
  opacity: 0;
}
.outer-wrapper input[type="checkbox"]:checked:after {
  opacity: 1;
}
.outer-wrapper .tool-tip {
  position: absolute;
  padding: 10px;
  background-color: #333;
  pointer-events: none;
  opacity: 0;
  z-index: 100;
}
.outer-wrapper .tool-tip p {
  margin: 0;
  padding: 0;
  color: #ECF0F1;
}
.outer-wrapper .tool-tip:before {
  content: "";
  position: absolute;
  top: -10px;
  left: 48%;
  border-right: 0;
  border-top: 0;
  border-bottom: 10px solid #333;
  border-left: 10px solid transparent;
}
.outer-wrapper .tool-tip.hidden {
  display: none;
}
.outer-wrapper .axis path, .outer-wrapper .axis line {
  fill: none;
  stroke: #666;
  shape-rendering: crispEdges;
}
.outer-wrapper .axis text {
  font-family: sans-serif;
  fill: #666;
  font-size: 13px;
  shape-rendering: crispEdges;
}

</style>
<h2>Top 100 cited papers of all time</h2>
<p>Lorem ipsum dolor sit amet, consectetur adipisicing elit. Id nobis exercitationem quam reprehenderit similique nulla aliquam!</p>

<div class="outer-wrapper">
	
	<div class="chart">
		<div class="tool-tip">
		</div>
	</div>

	<h3>Select discipline:</h3>

	<form class="choose-option"></form>

	<h3>Select stacking order:</h3>

	<form class="choose-order">
		<select name="select-choice" id="select-choice">
			<option value="cites">By number of citations</option>
			<option value="year">By year published</option>
		</select>
	</form>

</div>
<!--[if gt IE 8]><!-->
<script type="text/javascript">
function tooltip (width,margin,duration) {
	var format = d3.format("0,000");

	d3.select(".outer-wrapper .chart .tool-tip")
		.style("left", margin.left + "px")
		.style("width", (width - 20)+ "px");

	d3.select("svg g.hiddenBarsGroup").selectAll("rect").on("mouseover", function (d,i) {
		var title = d.title;
		var author = d.author;
		var cites = format(d.cites);
		var year = d.year;
		var thisIndex = i;

		var y = parseInt(d3.select(this).attr("y"),10);

		d3.select(".outer-wrapper .chart .tool-tip")
			.html("<p>" + cites + " citations.</p><p>" + title + ".</p><p>" + author + ". " + year + ".</p>")
			.style("top", (margin.top + 12 + y) + "px")
			.classed("hidden", false)
			.transition()
			.duration(duration/2)
			.style("opacity", 1);

		d3.select(this).attr("opacity",0.4);
	})
	.on("mouseout", function (d, i) {
		d3.select(this).attr("opacity", 0);

		d3.select(".outer-wrapper .chart .tool-tip")
			.transition()
			.delay(duration/4)
			.duration(duration/2)
			.style("opacity", 0)
			.each("end", function() {
				d3.select(".outer-wrapper .chart .tool-tip").classed("hidden", true);
			});
	});

}
function handleChange (dataSet, activeArray, delay, myGraphic) {
	var startingLength = activeArray.length;

	/* First remove the existing data from the arrays */
	while (activeArray.length > 0) {
		activeArray.shift();
	}

	activeArray = updateArray(dataSet);

	if (startingLength < activeArray.length) {
		delay = 0;
	}

	return {
		activeArray: activeArray,
		activeDelay: delay
	};

}
function updateArray (ary) {
	selectedArray = [];
	selections = [];

	var checkboxes = jQuery('.outer-wrapper form.choose-option input:checked');
	stackingOrder = jQuery('.outer-wrapper form.choose-order select').val();

	for (var v = 0; v < checkboxes.length; v++) {
		selections.push(checkboxes.eq(v).parent().text());
	}

	for (var i = 0; i < ary.length; i++) {
		var thisDiscipline = ary[i].discipline;
		
		if (selections.indexOf(thisDiscipline) !== -1) {
			selectedArray.push(ary[i]);
		}
	}

	if (stackingOrder === "cites") {
		selectedArray.sort(comparePaper);
	} else if (stackingOrder === "year") {
		selectedArray.sort(compareYear);
	}


	return selectedArray;
}
function createCheckboxes (data, colour) {


 	sortedData = [];

 	for (var i = 0; i < data.length; i++) {
 		sortedData.push(data[i]);
 	}

 	sortedData.sort();

	/* Create checkboxes for each discipline */
	d3.select(".outer-wrapper .choose-option")
		.append("ul")
		.selectAll('li')
	  .data(sortedData)
		.enter()
		.append("li")
		.style("border-left",function (d, i) {
			return "10px solid " + getColour (d, colour, data);
		})
		.html(function(d,i) {
			var name = d;
			var safeName  = name.toLowerCase().split(' ').join("-");

			var innerHTML = "<input type='checkbox' id='" + safeName + "' style='background-color:" + "#fff" + ";' checked><label for='" + safeName + "'>" + name + "</label>";
			
			return innerHTML;
		});
}

function getColour (x, colour, discipline) {
	var colourIndex = discipline.indexOf(x);

	return colour[colourIndex];
}
/*	Function to sort papers by citation */
function comparePaper(a,b) {
	if (a.cites < b.cites)
		return 1;
	if (a.cites > b.cites)
		return -1;
	return 0;
}

/*	Function to sort papers by year */
function compareYear(a,b) {
	if (a.year === b.year) {
		if (a.cites < b.cites)
			return 1;
		if (a.cites > b.cites)
			return -1;
		return 0;
	}

	if (a.year < b.year)
		return 1;
	if (a.year > b.year)
		return -1;
	return 0;
}
function buildGraphic (topData, discipline, margin, width, height, colour, duration, delay) {

	var svg = d3.select(".outer-wrapper .chart").append("svg")
		.attr("width", width + margin.left + margin.right)
		.attr("height", height + margin.top + margin.bottom);

	var barsGroup = svg.append('g')
						.attr("class","barsGroup")
						.attr("transform","translate(" + margin.left + "," + margin.top + ")");

	var hiddenBarsGroup = svg.append('g')
						.attr("class","hiddenBarsGroup")
						.attr("transform","translate(" + margin.left + "," + margin.top + ")");
	
	
	/*	Scales */
	var xScale = d3.scale.linear()
		.range([0 , width])
		.domain([d3.min(topData, function(d) { return d.cites;}), d3.max(topData, function(d) { return d.cites;})]);

	var halfXScale = d3.scale.linear()
		.range([0 , (width/2)])
		.domain([d3.min(topData, function(d) { return d.cites;}), d3.max(topData, function(d) { return d.cites;})]);

	var yScale = d3.scale.ordinal()
		.rangeBands([0, height], 0.2, 0)
		.domain(d3.range(topData.length));

	/*	Define X axis */
	var xAxis = d3.svg.axis()
		.scale(halfXScale)
		.tickSize(-height, -height)
		.ticks(4)
		.orient("top");

	/*	Prepare the x axis but do not call .call(xAxis) yet */
	svg.append("g")
		.attr("class", "x axis")
		.attr("transform", "translate(" + (margin.left + width/2) + "," + margin.top + ")")
	  .append("g")
		.attr("class", "axisLabel")
	  .append("text")
	  	.attr("transform", "translate(" + (width/4) + "," + -(margin.top/2) + ")")
	  	.style("text-anchor", "middle")
	  	.text("Citations");

	function update (grp, data, updateDelay, visible) {
		grp.selectAll("rect").data(data, function (d) {
				return d.title;
			})
			.transition()
			.duration(duration)
			.delay(updateDelay)
			.attr("x", function (d) {
				return visible ? (width/2) - (xScale(d.cites) / 2) : 0;
			})
			.attr("width", function(d) {
				return visible ? xScale(d.cites) : width;
			})
			.attr("y", function(d, i){
				return yScale(i);
			})
			.attr("height", function () {
				return yScale.rangeBand();
			});
	}

	function enter (grp, data, visible) {
		grp.selectAll("rect").data(data, function (d) {
				return d.title;
			})
			.enter()
			.append("rect")
			.attr("x", function (d) {
				return visible ? (width/2) : 0;
			})
			.attr("width", 0)
			.attr("y", function(d, i){
				return yScale(i);
			})
			.attr("height", function () {
				return yScale.rangeBand();
			})
			.attr("fill", function(d, i){
				return visible ? getColour(d.discipline, colour, discipline): "hotpink";
			})
			.attr("opacity", function () {
				return visible ? 1 : 0;
			})
			.transition()
			.duration(duration)
			.delay(delay)
			.attr("width", function(d) {
				return visible ? xScale(d.cites) : width;
			})
			.attr("x", function (d) {
				return visible ? (width/2) - (xScale(d.cites) / 2) : 0;
			});
	}

	function exit (grp, data) {
		grp.selectAll("rect").data(data, function (d) {
				return d.title;
			}).exit()
			.transition()
			.duration(duration)
			.delay(0)
			.attr("x", function (d) {
				return (width/2);
			})
			.attr("width", 0)
			.remove();
	}

	function updateBars (data, updateDelay) {

		xScale.domain([d3.min(data, function(d) { return d.cites;}), d3.max(data, function(d) { return d.cites;})]);
		halfXScale.domain([d3.min(data, function(d) { return d.cites;}), d3.max(data, function(d) { return d.cites;})]);
		yScale.domain(d3.range(data.length));

		/* Update */
		update(barsGroup, data, updateDelay, true);
		update(hiddenBarsGroup, data, updateDelay, false);

		/* Enterâ€¦ */
		enter(barsGroup, data, true);
		enter(hiddenBarsGroup, data, false);

		/* Exit */
		exit(barsGroup, data);
		exit(hiddenBarsGroup, data);

		/* Call the Y axis to adjust it to the new scale */
		svg.select(".outer-wrapper .chart .x")
			.transition()
			.duration(duration)
			.call(xAxis);

		tooltip(width, margin, duration);

	}

	return {
		updateBars: function (data, updateDelay) {
			updateBars(data, updateDelay);
		}

	};


}
function buildSVG (margin, width, height) {

}
function buildDataSet (data) {
	var dataSet = [];

	var tableRows = jQuery(data).find("tbody tr");
	var headerRows = jQuery(data).find("thead tr").find('th');

	var discipline = [];

	for (var i = 0; i < tableRows.length; i++) {
		var newObject = {};

		newObject.author = tableRows.eq(i).find("td").eq(0).text();
		newObject.title = tableRows.eq(i).find("td").eq(1).text();
		newObject.publication = tableRows.eq(i).find("td").eq(2).text();
		
		newObject.cites = parseInt(tableRows.eq(i).find("td").eq(3).text(), 10);

		newObject.year = parseInt(tableRows.eq(i).find("td").eq(4).text(), 10);
		
		newObject.doi = tableRows.eq(i).find("td").eq(5).text();

		my_discipline = tableRows.eq(i).find("td").eq(6).text();

		newObject.discipline = my_discipline;

		if (discipline.indexOf(my_discipline) === -1 ) {
			discipline.push(my_discipline);
		}
		
		dataSet.push(newObject);
	}

	return {
		dataSet: dataSet,
		discipline: discipline
	};
}
(function() {
		var init = function($)
		{

		/*	==================================================================================== */
		/*	GLOBAL VARIABLES FOR D3 */

		/*  Colours for the bars */
		// var colour = ["#1abc9c","#27ae60","#3498db","#5959b7","#EB6B4B"];

		var colour =	["#c1272d",
						"#ed1c24",
						"#f15a24",
						"#f7931e",
						"#fbb03b",
						"#fcee21",
						"#d9e021",
						"#8cc63f",
						"#39b54a",
						"#006837",
						"#00a99d",
						"#29abe2",
						"#0071bc",
						"#2e3192",
						"#1b1464",
						"#662d91",
						"#93278f",
						"#9e005d",
						"#c69c6d",
						"#a67c52",
						"#8c6239",
						"#754c24",
						"#754c24",
						"#603813",
						"#42210b"];

		/*	Margin, Width and height */
		var margin = {top: 50, right: 20, bottom: 20, left: 20};
		var width = $('.section').width()  - margin.left - margin.right;
		var height = 600 - margin.top - margin.bottom;
		/*	Global variable to control the length of D3 transitons */
		var duration = 450;
		var delay = duration;
		var updateDelay = 0;
		var activeRecord = {};

		var topData;
		var myGraphic;
		var displayArray = [];

		/*	==================================================================================== */
		/*	jQuery ready */

			/*	==================================================================================== */
			/*	Load D3 */
			/*	All of the D3/svg code is contained within the call back function */
			/*	Loading D3 into ie6-8 seems to cause a runtime error */
			$.getScript("http://www.nature.com/polopoly_static/js/d3.v3.min.js", function() {

				$.ajax({
					url: "data/top-100-edit-table.html",
					// url: "https://poly-admin1.nature.com/preview/www/2.788/1.15117/7.20172",
					dataType: 'text',
					success: function (data) {
						topData = buildDataSet(data);
					}

				}).done(function () {
					
					createCheckboxes(topData.discipline, colour);
					
					displayArray = updateArray(topData.dataSet);

					myGraphic = buildGraphic(displayArray, topData.discipline, margin, width, height, colour, duration, delay);
					myGraphic.updateBars(displayArray, updateDelay);

					$('.outer-wrapper form.choose-order select').change(function () {
						activeRecord = handleChange(topData.dataSet, displayArray, delay, myGraphic);

						displayArray = activeRecord.activeArray;

						myGraphic.updateBars(displayArray, activeRecord.activeDelay);
					});

					d3.selectAll('.outer-wrapper form.choose-option input').on('change', function () {
						activeRecord = handleChange(topData.dataSet, displayArray, delay, myGraphic);

						displayArray = activeRecord.activeArray;

						myGraphic.updateBars(displayArray, activeRecord.activeDelay);

					});

				}); /* End of ajax call */

			}); /* End of d3js getscript call

		/* End of active code */
		};


	setTimeout(function()
	{
	if (typeof jQuery !== 'undefined')
	{
		init(jQuery);
	} else
	{
		setTimeout(arguments.callee, 60);
	}
	}, 60);

})();
</script>
<!--<![endif]-->